/*
DESCRIPTION:

	Store X is a struggling small business that has been hit hard by supply chain delays and 
	
	inventory management issues. As such, many popular products are frequently under-stocked,
	
	turning away customers that otherwise would have spent more. As such, the goal of this
	
	data analysis project is to use SQL to determine which products are highest-performing
	
	(sell the most) yet are constantly in low stock, who the highest- and lowest-spending
	
	customers are, and the average profit that each customer brings in during their lifetime
	
	that can be re-spent and invested into the store.
	
	
	
	As it turns out, the Classic Cars product line make up the majority of the top 10 most 
	
	in-demand and low-stock products in Store X, meaning they should be re-stocked most often
	
	to optimize inventory needs. The highest- and lowest-spending customers tend to vary with
	
	no clear pattern, and the average customer brings in $39,039.59 over their lifetime in 
	
	Store X. These findings may be used to help Store X determine how it can better optimize
	
	its inventory and wisely calculate how its available funds can attract new customers.

	Code was written and run using DB Browser.
*/


*/</sql><sql name="Table Overview">


-- 1: familiarizing with the database: each table's name, number of columns (attributes), and number of rows


	SELECT 'Customers' AS table_name,
	
		   '13' AS number_of_attributes,
	
		   COUNT(*) AS number_of_rows
	
	  FROM customers
	
	UNION ALL
	
	SELECT 'Products' AS table_name,
	
		   '9' AS number_of_attributes,
	
		   COUNT(*) AS number_of_rows
	
	  FROM products
	
	UNION ALL
	
	SELECT 'ProductLines' AS table_name,
	
		   '4' AS number_of_attributes,
	
		   COUNT(*) AS number_of_rows
	
	  FROM productlines
	
	UNION ALL

	SELECT 'Orders' AS table_name,
	
		   '7' AS number_of_attributes,
	
		   COUNT(*) AS number_of_rows
	
	  FROM orders
	
	UNION ALL
	
	SELECT 'OrderDetails' AS table_name,
	
		   '5' AS number_of_attributes,
	
		   COUNT(*) AS number_of_rows
	
	  FROM orderdetails
	
	UNION ALL
	
	SELECT 'Payments' AS table_name,
	
		   '4' AS number_of_attributes,
	
		   COUNT(*) AS number_of_rows
	
	  FROM payments
	
	UNION ALL
	
	SELECT 'Employees' AS table_name,
	
		   '8' AS number_of_attributes,
	
		   COUNT(*) AS number_of_rows
	
	  FROM employees
	
	UNION ALL
	
	SELECT 'Offices' AS table_name,
	
		   '9' AS number_of_attributes,
	
		   COUNT(*) AS number_of_rows;

  	  FROM offices;

/* Output:
1	table_name	number_of_attributes	number_of_rows
2	Customers	13			122
3	Products	9			110
4	ProductLines	4			7
5	Orders		7			326
6	OrderDetails	5			2996
7	Payments	4			273
8	Employees	8			23
9	Offices		9			7
*/



</sql><sql name="Product Optimization Analysis">



/* 
2: determining which items are low stock and high performance; 

combining the two with a CTS query to find which items should 

be kept constantly restocked, helping the store optimize inventory.

As it turns out, the Classic Cars product line make up the majority of the 

top 10 most in-demand and low-stock products in this store. As such, they 

should be re-stocked most often to optimize inventory needs.
*/



	WITH
	
	product_performance_table AS (
	
		SELECT productCode, SUM(quantityOrdered * priceEach) AS product_performance
	
		  FROM orderdetails
	
		 GROUP BY productCode
	
		 ORDER BY product_performance DESC
	
		 LIMIT 10
	
	)
	
	
	
	SELECT productCode AS priority_product_codes, productLine, productName,
	
		   ROUND((SELECT SUM(quantityOrdered) * 1.0
	
				    FROM orderdetails AS od
	
				   WHERE od.productCode = p.productCode) 
	
				 / quantityInStock, 2) AS low_stock
	
	  FROM products AS p
	
	 WHERE productCode IN (SELECT productCode
	
						     FROM product_performance_table)
	
	 GROUP BY productCode
	
	 ORDER BY low_stock DESC
	
	 LIMIT 10;

 

	 /* 
	
	low_stock code:
	
	SELECT productCode,
	
		   ROUND((SELECT SUM(quantityOrdered) * 1.0
	
				    FROM orderdetails AS od
	
				   WHERE od.productCode = p.productCode	
	
				 ) / quantityInStock, 2) AS low_stock
	
	  FROM products AS p
	
	 GROUP BY productCode
	
	 ORDER BY low_stock DESC
	
	 LIMIT 10;
	
	
	
	product performance code:
	
	SELECT productCode, SUM(quantityOrdered * priceEach) AS product_performance
	
	  FROM orderdetails
	
	 GROUP BY productCode
	
	 ORDER BY product_performance DESC
	
	 LIMIT 10;
	
	*/

/* Output:
	priority_product_codes	productLine	productName				low_stock
1	S12_1099		Classic Cars	1968 Ford Mustang			13.72
2	S12_3891		Classic Cars	1969 Ford Falcon			0.92
3	S18_1749		Vintage Cars	1917 Grand Touring Sedan		0.34
4	S12_1108		Classic Cars	2001 Ferrari Enzo			0.28
5	S18_3232		Classic Cars	1992 Ferrari 360 Spider red		0.22
6	S18_2238		Classic Cars	1998 Chrysler Plymouth Prowler		0.21
7	S18_1662		Planes		1980s Black Hawk Helicopter		0.2
8	S10_4698		Motorcycles	2003 Harley-Davidson Eagle Drag Bike	0.18
9	S10_1949		Classic Cars	1952 Alpine Renault 1300		0.13
10	S12_2823		Motorcycles	2002 Suzuki XREO			0.1
*/


 */</sql><sql name="Customer Spending Analysis">

/* 3. determining which customers spend the most and which spend the least to help

influence potential marketing campaigns, ex. how to retain the loyalest customers */



	WITH
	
	customer_profits AS (
	
	SELECT o.customerNumber, SUM(od.quantityOrdered * (od.priceEach - p.buyPrice)) AS profit
	
	  FROM orders AS o
	
	  JOIN orderdetails AS od
	
	    ON o.orderNumber = od.orderNumber
	
	  JOIN products AS p
	
	    ON od.productCode = p.productCode
	
	 GROUP BY o.customerNumber
	
	)
	
	
	
	-- the 5 highest-spending customers
	
	SELECT c.contactLastName, c.contactFirstName, c.city, c.country, customer_profits.profit
	
	  FROM customers AS c
	
	  JOIN customer_profits
	
	    ON customer_profits.customerNumber = c.customerNumber
	
	 ORDER BY customer_profits.profit DESC
	
	 LIMIT 5;
	
	 
	
	-- the 5 lowest-spending customers (uncomment code)
	
	SELECT c.contactLastName, c.contactFirstName, c.city, c.country, customer_profits.profit
	
	  FROM customers AS c
	
	  JOIN customer_profits
	
	    ON customer_profits.customerNumber = c.customerNumber
	
	 ORDER BY customer_profits.profit
	
	 LIMIT 5;

/* Output:
	contactLastName	 contactFirstName  city		country		profit
1	Freyre		 Diego 		   Madrid	Spain		326519.66
2	Nelson		 Susan		   San Rafael	USA		236769.39
3	Young		 Jeff		   NYC		USA		72370.09
4	Ferguson	 Peter		   Melbourne	Australia	70311.07
5	Labrune		 Janine 	   Nantes	France		60875.3
*/


</sql><sql name="Average Customer Profits">


/*
4. determining how much the store can spend attracting new customers by calculating
the average profit per customer
*/


	WITH
	
	customer_profits AS (
	
	SELECT o.customerNumber, SUM(od.quantityOrdered * (od.priceEach - p.buyPrice)) AS profit
	
	  FROM orders AS o
	
	  JOIN orderdetails AS od
	
	    ON o.orderNumber = od.orderNumber
	
	  JOIN products AS p
	
	    ON od.productCode = p.productCode
	
	 GROUP BY o.customerNumber
	
	)
	
	
	
	SELECT ROUND(AVG(customer_profits.profit), 2) AS average_customer_profits
	
	  FROM customer_profits;


/* Output:
	average_customer_profits
1	39039.59

*/
